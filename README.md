# Lead Distribution CRM

Мини-CRM для распределения лидов между операторами по источникам.

## Запуск

```bash
docker-compose up --build
```

При первом запуске Liquibase автоматически применит миграции и создаст таблицы в SQLite базе.

После запуска API доступен по адресу http://localhost:8000

Документация Swagger: http://localhost:8000/docs

## Модель данных

### Operator (Оператор)
- `id` — UUID
- `name` — имя оператора
- `is_active` — активен ли (может принимать обращения)
- `max_leads` — лимит активных обращений

### Lead (Лид)
- `id` — UUID  
- `external_id` — внешний идентификатор (уникальный, для идентификации лида)
- `phone`, `email`, `name` — контактные данные

### Source (Источник/бот)
- `id` — UUID
- `name` — название источника
- `code` — уникальный код

### OperatorWeight (Распределение)
- `operator_id` — ссылка на оператора
- `source_id` — ссылка на источник
- `weight` — вес (доля трафика)

### Request (Обращение)
- `id` — UUID
- `lead_id` — ссылка на лида
- `source_id` — ссылка на источник
- `operator_id` — назначенный оператор (может быть null)
- `message` — текст обращения
- `is_active` — активно ли обращение

## Алгоритм распределения

### 1. Идентификация лида

При создании обращения система ищет лида по полю `external_id`:
- Если лид найден — обращение привязывается к существующему лиду
- Если не найден — создается новый лид с переданными данными (phone, email, name)

Это позволяет отслеживать все обращения одного клиента из разных источников.

### 2. Определение доступных операторов

Система получает список операторов, настроенных для данного источника (через таблицу `OperatorWeight`), и фильтрует их:

1. **Проверка активности**: оператор должен иметь `is_active = true`
2. **Проверка лимита нагрузки**: текущее количество активных обращений < `max_leads`

**Нагрузка оператора** — это количество обращений с `is_active = true`, назначенных на него. Когда обращение закрывается (`POST /requests/{id}/close`), нагрузка уменьшается.

### 3. Взвешенный случайный выбор

Среди подходящих операторов выбор происходит случайным образом, но с учётом весов:

**Алгоритм:**
1. Вычисляется сумма весов всех подходящих операторов
2. Генерируется случайное число от 0 до суммы весов
3. Операторы перебираются последовательно, накапливая их веса
4. Выбирается оператор, на котором накопленный вес превысил случайное число

**Пример:**
- Оператор А: вес 10
- Оператор Б: вес 30
- Сумма весов: 40

Вероятности:
- Оператор А: 10/40 = 25%
- Оператор Б: 30/40 = 75%

При большом количестве обращений распределение будет стремиться к заданным пропорциям.

### 4. Обработка отсутствия операторов

Если подходящих операторов нет (все неактивны или превысили лимит), обращение создается с `operator_id = null`. Это позволяет:
- Не терять обращения
- Назначить оператора вручную позже
- Отслеживать нераспределённые обращения

## API

### Операторы

- `POST /api/v1/operators/` — создать оператора
- `GET /api/v1/operators/` — список операторов с текущей нагрузкой
- `PATCH /api/v1/operators/{id}` — изменить оператора (активность, лимит)

### Источники

- `POST /api/v1/sources/` — создать источник
- `GET /api/v1/sources/` — список источников
- `GET /api/v1/sources/{id}` — детали источника с привязанными операторами
- `POST /api/v1/sources/{id}/operators` — установить вес оператора для источника

### Обращения

- `POST /api/v1/requests/` — создать обращение (автоматическое распределение)
- `GET /api/v1/requests/` — список обращений
- `POST /api/v1/requests/{id}/close` — закрыть обращение

### Лиды

- `GET /api/v1/leads/` — список лидов с их обращениями

## Пример использования

```bash
# Создать операторов
curl -X POST http://localhost:8000/api/v1/operators/ \
  -H "Content-Type: application/json" \
  -d '{"name": "Иван", "maxLeads": 5}'

curl -X POST http://localhost:8000/api/v1/operators/ \
  -H "Content-Type: application/json" \
  -d '{"name": "Мария", "maxLeads": 10}'

# Создать источник
curl -X POST http://localhost:8000/api/v1/sources/ \
  -H "Content-Type: application/json" \
  -d '{"name": "Telegram Bot", "code": "tg_bot_1"}'

# Назначить операторов на источник с весами
curl -X POST http://localhost:8000/api/v1/sources/{source_id}/operators \
  -H "Content-Type: application/json" \
  -d '{"operatorId": "{operator1_id}", "weight": 30}'

curl -X POST http://localhost:8000/api/v1/sources/{source_id}/operators \
  -H "Content-Type: application/json" \
  -d '{"operatorId": "{operator2_id}", "weight": 70}'

# Создать обращение
curl -X POST http://localhost:8000/api/v1/requests/ \
  -H "Content-Type: application/json" \
  -d '{
    "leadExternalId": "user123",
    "sourceId": "{source_id}",
    "leadPhone": "+79001234567",
    "message": "Интересует консультация"
  }'
```
